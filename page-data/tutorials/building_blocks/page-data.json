{"componentChunkName":"component---src-templates-tutorials-js","path":"/tutorials/building_blocks/","result":{"data":{"markdownRemark":{"html":"<p>In this section, we will highlight the main building blocks and components of the BARK simulator framework.\n</br>\n</br>\nThe <b>core modules</b> of BARK are:</p>\n<ul class=\"list-disc list-inside\">\n<li>The <code class=\"language-text\">World</code> and <code class=\"language-text\">ObservedWorld</code> class that contains all elements of the simulation,</li>\n<li>the <code class=\"language-text\">Agent</code> class that represents dynamic objects,</li>\n<li>the <code class=\"language-text\">MapInterface</code> class that contains all map-related functionalities, and</li>\n<li>the model classes that specify how an agent moves/acts within BARK.\n</br>\n</br>\nWe only elaborate each of the above components slightly.\nFor deeper insights and a comprehensive overview of the components, we refer to our <a href=\"https://bark-simulator.readthedocs.io/en/latest/\" class=\"text-blue-600\">documentation</a>.</li>\n</ul>\n<h2 class=\"text-3xl text-gray-800 mt-10\">World and Observed World</h2>\n<p>The <code class=\"language-text\">World</code> class contains all objects, maps, and utilities of the simulation in BARK.\n<br />\n<br />\nA shortened implementation of the <code class=\"language-text\">World</code> class:</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">World</span> <span class=\"token operator\">:</span> <span class=\"token keyword\">public</span> commons<span class=\"token operator\">::</span>BaseType <span class=\"token punctuation\">{</span>\n <span class=\"token keyword\">public</span><span class=\"token operator\">:</span>\n  <span class=\"token keyword\">explicit</span> <span class=\"token function\">World</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> commons<span class=\"token operator\">::</span>ParamsPtr<span class=\"token operator\">&amp;</span> params<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">explicit</span> <span class=\"token function\">World</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> std<span class=\"token operator\">::</span>shared_ptr<span class=\"token operator\">&lt;</span>World<span class=\"token operator\">></span><span class=\"token operator\">&amp;</span> world<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">virtual</span> <span class=\"token operator\">~</span><span class=\"token function\">World</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n  std<span class=\"token operator\">::</span>vector<span class=\"token operator\">&lt;</span>ObservedWorld<span class=\"token operator\">></span> <span class=\"token function\">Observe</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> std<span class=\"token operator\">::</span>vector<span class=\"token operator\">&lt;</span>AgentId<span class=\"token operator\">></span><span class=\"token operator\">&amp;</span> agent_ids<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">void</span> <span class=\"token function\">Step</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token keyword\">float</span><span class=\"token operator\">&amp;</span> delta_time<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">void</span> <span class=\"token function\">DoPlanning</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token keyword\">float</span><span class=\"token operator\">&amp;</span> delta_time<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">void</span> <span class=\"token function\">DoExecution</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token keyword\">float</span><span class=\"token operator\">&amp;</span> delta_time<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">virtual</span> std<span class=\"token operator\">::</span>shared_ptr<span class=\"token operator\">&lt;</span>World<span class=\"token operator\">></span> <span class=\"token function\">Clone</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n <span class=\"token keyword\">private</span><span class=\"token operator\">:</span>\n  world<span class=\"token operator\">::</span>map<span class=\"token operator\">::</span>MapInterfacePtr map_<span class=\"token punctuation\">;</span>\n  AgentMap agents_<span class=\"token punctuation\">;</span>\n  ObjectMap objects_<span class=\"token punctuation\">;</span>\n  std<span class=\"token operator\">::</span>map<span class=\"token operator\">&lt;</span>std<span class=\"token operator\">::</span>string<span class=\"token punctuation\">,</span> EvaluatorPtr<span class=\"token operator\">></span> evaluators_<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">double</span> world_time_<span class=\"token punctuation\">;</span>\n  rtree_agent rtree_agents_<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">bool</span> remove_agents_<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>The most important class members are the agent map <code class=\"language-text\">agents_</code>, static objects <code class=\"language-text\">objects_</code>, and the map interface <code class=\"language-text\">map_</code>.\nThe <code class=\"language-text\">Step</code> function calls the <code class=\"language-text\">DoPlanning</code> and then the <code class=\"language-text\">DoExecution</code> function.\nEach agent plans in the <code class=\"language-text\">DoPlanning</code> phase using an <code class=\"language-text\">ObservedWorld</code> â€“ an agent-specific derived world.\nThe <code class=\"language-text\">Observe</code> function creates agent-specific observed worlds.\nAfter planning has finished, the <code class=\"language-text\">DoExecution</code> then executes the planned behaviors (trajectories).\n<br />\n<br />\nThe <code class=\"language-text\">ObservedWorld</code> additionally stores an <code class=\"language-text\">AgentId</code> for which it also provides extra interfaces and utilities.\nFurthermore, during the derivation, effects, such as occlusions can be modeled.\n<br />\n<br />\nExcerpt of the <code class=\"language-text\">ObservedWorld</code> class showing some of the additional functionalities:</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">ObservedWorld</span> <span class=\"token operator\">:</span> <span class=\"token keyword\">public</span> World <span class=\"token punctuation\">{</span>\n <span class=\"token keyword\">public</span><span class=\"token operator\">:</span>\n  <span class=\"token function\">ObservedWorld</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> WorldPtr<span class=\"token operator\">&amp;</span> world<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> AgentId<span class=\"token operator\">&amp;</span> ego_agent_id<span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span>\n    <span class=\"token function\">World</span><span class=\"token punctuation\">(</span>world<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function\">ego_agent_id_</span><span class=\"token punctuation\">(</span>ego_agent_id<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n  <span class=\"token operator\">~</span><span class=\"token function\">ObservedWorld</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n  FrontRearAgents <span class=\"token function\">GetAgentFrontRear</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n  std<span class=\"token operator\">::</span>shared_ptr<span class=\"token operator\">&lt;</span><span class=\"token keyword\">const</span> Agent<span class=\"token operator\">></span> <span class=\"token function\">GetEgoAgent</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> World<span class=\"token operator\">::</span><span class=\"token function\">GetAgent</span><span class=\"token punctuation\">(</span>ego_agent_id_<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  AgentId <span class=\"token function\">GetEgoAgentId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> ego_agent_id_<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">const</span> std<span class=\"token operator\">::</span>shared_ptr<span class=\"token operator\">&lt;</span>BehaviorModel<span class=\"token operator\">></span> <span class=\"token function\">GetEgoBehaviorModel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> World<span class=\"token operator\">::</span><span class=\"token function\">GetAgent</span><span class=\"token punctuation\">(</span>ego_agent_id_<span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">GetBehaviorModel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">virtual</span> State <span class=\"token function\">CurrentEgoState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> World<span class=\"token operator\">::</span><span class=\"token function\">GetAgent</span><span class=\"token punctuation\">(</span>ego_agent_id_<span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">GetCurrentState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  Point2d <span class=\"token function\">CurrentEgoPosition</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> World<span class=\"token operator\">::</span><span class=\"token function\">GetAgent</span><span class=\"token punctuation\">(</span>ego_agent_id_<span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">GetCurrentPosition</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n <span class=\"token keyword\">private</span><span class=\"token operator\">:</span>\n  AgentId ego_agent_id_<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2 class=\"text-3xl text-gray-800 mt-10\">Agent</h2>\n<p>The agents (vehicles) in BARK are dynamic objects that have a behavior, execution, and dynamic model.\nEach agent in BARK has a goal definition.\nThe behavior model that generates actions and trajectories should try to reach the set goal.\nIn order to simplify the map handling, we introduce RoadCorridors â€“ multiple concatenated roads generated by a routing function.\n<br />\n<br />\nExcerpt of the agent class:</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">Agent</span> <span class=\"token operator\">:</span> <span class=\"token keyword\">public</span> Object <span class=\"token punctuation\">{</span>\n <span class=\"token keyword\">public</span><span class=\"token operator\">:</span>\n  <span class=\"token keyword\">friend</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">World</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">Agent</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> State<span class=\"token operator\">&amp;</span> initial_state<span class=\"token punctuation\">,</span>\n        <span class=\"token keyword\">const</span> BehaviorModelPtr<span class=\"token operator\">&amp;</span> behavior_model_ptr<span class=\"token punctuation\">,</span>\n        <span class=\"token keyword\">const</span> DynamicModelPtr<span class=\"token operator\">&amp;</span> dynamic_model_ptr<span class=\"token punctuation\">,</span>\n        <span class=\"token keyword\">const</span> ExecutionModelPtr<span class=\"token operator\">&amp;</span> execution_model<span class=\"token punctuation\">,</span>\n        <span class=\"token keyword\">const</span> geometry<span class=\"token operator\">::</span>Polygon<span class=\"token operator\">&amp;</span> shape<span class=\"token punctuation\">,</span>\n        <span class=\"token keyword\">const</span> commons<span class=\"token operator\">::</span>ParamsPtr<span class=\"token operator\">&amp;</span> params<span class=\"token punctuation\">,</span>\n        <span class=\"token keyword\">const</span> GoalDefinitionPtr<span class=\"token operator\">&amp;</span> goal_definition <span class=\"token operator\">=</span> <span class=\"token function\">GoalDefinitionPtr</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token keyword\">const</span> MapInterfacePtr<span class=\"token operator\">&amp;</span> map_interface <span class=\"token operator\">=</span> <span class=\"token function\">MapInterfacePtr</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token keyword\">const</span> geometry<span class=\"token operator\">::</span>Model3D<span class=\"token operator\">&amp;</span> model_3d <span class=\"token operator\">=</span> geometry<span class=\"token operator\">::</span><span class=\"token function\">Model3D</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n <span class=\"token keyword\">private</span><span class=\"token operator\">:</span>\n  BehaviorModelPtr behavior_model_<span class=\"token punctuation\">;</span>\n  DynamicModelPtr dynamic_model_<span class=\"token punctuation\">;</span>\n  ExecutionModelPtr execution_model_<span class=\"token punctuation\">;</span>\n  RoadCorridorPtr road_corridor_<span class=\"token punctuation\">;</span>\n  StateActionHistory history_<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">uint32_t</span> max_history_length_<span class=\"token punctuation\">;</span>\n  GoalDefinitionPtr goal_definition_<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2 class=\"text-3xl text-gray-800 mt-10\">Map Interface</h2>\n<p>The <code class=\"language-text\">MapInterface</code> stores the OpenDrive map, generates a <code class=\"language-text\">RoadGraph</code>, and the road corridors.</p>\n<h3 class=\"text-2xl text-gray-800 mt-2\">Road- and LaneCorridors</h3>\n<p>Each agent in BARK has a <code class=\"language-text\">RoadCorridor</code> which consists of multiple sequential and connected roads.\nThe road corridor is usually generated using a routing function.\n<br />\n<br />\nExcerpt of the <code class=\"language-text\">RoadCorridor</code> class:</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token keyword\">struct</span> <span class=\"token class-name\">RoadCorridor</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n  <span class=\"token function\">GetLeftRightLaneCorridor</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> Point2d<span class=\"token operator\">&amp;</span> pt<span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">static</span> std<span class=\"token operator\">::</span>size_t <span class=\"token function\">GetHash</span><span class=\"token punctuation\">(</span>\n    <span class=\"token keyword\">const</span> XodrDrivingDirection<span class=\"token operator\">&amp;</span> driving_direction<span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">const</span> std<span class=\"token operator\">::</span>vector<span class=\"token operator\">&lt;</span>XodrRoadId<span class=\"token operator\">></span><span class=\"token operator\">&amp;</span> road_ids<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// calculate hash using driving_direction and road_ids</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n  <span class=\"token punctuation\">}</span>\n\n  Roads roads_<span class=\"token punctuation\">;</span>\n  Polygon road_polygon_<span class=\"token punctuation\">;</span>\n  std<span class=\"token operator\">::</span>vector<span class=\"token operator\">&lt;</span>LaneCorridorPtr<span class=\"token operator\">></span> unique_lane_corridors_<span class=\"token punctuation\">;</span>\n  std<span class=\"token operator\">::</span>vector<span class=\"token operator\">&lt;</span>XodrRoadId<span class=\"token operator\">></span> road_ids_<span class=\"token punctuation\">;</span>\n  std<span class=\"token operator\">::</span>map<span class=\"token operator\">&lt;</span>LaneId<span class=\"token punctuation\">,</span> LaneCorridorPtr<span class=\"token operator\">></span> lane_corridors_<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>The <code class=\"language-text\">RoadCorridor</code> polygon is depicted in light blue and the LaneCorridors (consecutive lanes) are outlined in blue:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 615px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/7ab755d99384a2525fa3c772453ffd48/f6b72/roadcorridor_%5B0%2C%202%2C%204%5D.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 55.99999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAA9hAAAPYQGoP6dpAAAA+ElEQVQoz6WQzWrCQBSF53kLWvANfI7YSui22LrWbNxooqVBC4KKoRA1VGOy8I9k7pyOJioSkqY4cObODNxvzrkM/1hCiD/FarqNt66N94RmqPdsqRm0vgNnvZVEQhhyEBE45zc6vzGlMYXStFBpRlU51ev5SbPQGjh41kZYehvJ5BIaJnSEBUEAlifq17eP0osJ292e7kQZkUluaeKy8bjaoxUK6iccbx8BhUj9nGUNmGKgMXZRlMDFencBpjrMinoG6uNVApjqMA/QmLh4VE0s8kTOA+zIGT5UPzC/22HcaFo+yq9D/PiH+4Aibgy5wO5AF8ciA/gL89RQrs/JbE0AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"RoadCorridor\"\n        title=\"RoadCorridor\"\n        src=\"/static/7ab755d99384a2525fa3c772453ffd48/f6b72/roadcorridor_%5B0%2C%202%2C%204%5D.png\"\n        srcset=\"/static/7ab755d99384a2525fa3c772453ffd48/772e8/roadcorridor_%5B0%2C%202%2C%204%5D.png 200w,\n/static/7ab755d99384a2525fa3c772453ffd48/e17e5/roadcorridor_%5B0%2C%202%2C%204%5D.png 400w,\n/static/7ab755d99384a2525fa3c772453ffd48/f6b72/roadcorridor_%5B0%2C%202%2C%204%5D.png 615w\"\n        sizes=\"(max-width: 615px) 100vw, 615px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h2 class=\"text-3xl text-gray-800 mt-10\">Models in BARK</h2>\n<p>We will discuss the BARK models in the next section when we develop our first behavior model.</p>","frontmatter":{"title":"Building Blocks"}}},"pageContext":{"slug":"/tutorials/building_blocks/"}}}